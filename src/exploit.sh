
WAIT_TIME=10
LOAD_TIME=60

function init {
  ALL_UP=true
  echo "INIT"
  echo "CHECKING TWEETS"
  if [[ $(echo "exists 'tweets'" | docker exec -i hbase-master hbase shell | grep 'not exist') ]]; then 
    echo "CREATING TWEETS"
    echo "create 'tweets','t','u','e','p'" | docker exec -i hbase-master hbase shell;
    ALL_UP=false
  fi
  echo "CHECKING MENTIONS"
  if [[ $(echo "exists 'mentions'" | docker exec -i hbase-master hbase shell | grep 'not exist') ]]; then 
    echo "CREATING MENTIONS"
    echo "create 'mentions','f'" | docker exec -i hbase-master hbase shell;
    ALL_UP=false
  fi
  echo "CHECKING MENTIONED"
  if [[ $(echo "exists 'mentioned'" | docker exec -i hbase-master hbase shell | grep 'not exist') ]]; then 
    echo "CREATING MENTIONED"
    echo "create 'mentioned','f'" | docker exec -i hbase-master hbase shell;
    ALL_UP=false
  fi
  if [[ ALL_UP -eq false ]]; then
    echo "CREATING HIVE"
    docker exec -i hive-server hive -f ./scripts/initTables.hql;
  fi
}

function flume_cicle {
  echo "FLUME CICLE"
  for SOURCE in "TwitterSpainpbKeywords" "TwitterBarcelona" "TwitterSpainPB" "TwitterMadrid" "TwitterKeywords"; do
    echo "DATA $SOURCE START; FOR $LOAD_TIME"
    docker-compose -f docker-compose-data.yml run flume-$SOURCE & sleep $LOAD_TIME ; kill $!
    echo "DATA $SOURCE END; WAITING FOR $WAIT_TIME"
    sleep $WAIT_TIME
  done
}

function pig_load_data {
  echo "PIG LOAD"
  docker-compose -f docker-compose-data.yml run pig
}

function hdfs_clear_data {
  echo "HDFS CLEAR"
  docker exec namenode hadoop fs -rm -r -f /user/hduser/flume/twitter
}

init
while true; do
  flume_cicle
  pig_load_data
  hdfs_clear_data
done